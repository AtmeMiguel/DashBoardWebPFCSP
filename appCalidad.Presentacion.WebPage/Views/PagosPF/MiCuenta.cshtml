@{
    ViewBag.Title = "Mi Cuenta";
    Layout = "~/Views/Shared/_MasterInternoPagosPF.cshtml";
  
    string SERVIDOR = System.Configuration.ConfigurationManager.AppSettings["SERVIDOR"];
}


<div id="app">
    <div class="container-fluid">

        <div class="row justify-content-center">


            <div v-if="v_paso=='1'" class="col-lg-12" style="background-color: #FAFAFA;border-radius:25px;">
                <div style="height:350px;">
                    <br />
                    <br />
                    <br />
                    <p style="font-size:28px;font-weight:600;">Actualizar mi cuenta</p>
                    <br />

                    <template v-if="msgAlerta == '' ">
                        <p style="color:#818181;font-size:14px;">Obteniendo información...</p>
                        <br />
                        <br />
                    </template>
                    <template v-else>
                        <p style="font-size: 15px;" class="msgAlertaInt">{{msgAlerta}}</p>
                        <br />
                        <br />
                    </template>
                </div>
            </div>



            <div v-if="v_paso=='2'" class="col-lg-12" style="background-color: #FAFAFA;border-radius:25px;">
                <br />
                <br />
                <br />
                <p style="font-size:28px;font-weight:600;">Actualizar datos de cuenta</p>
                @*<br />
                    <p style="color:#818181;font-size:14px;">Actualice sus datos.</p>*@
                <br />
                <br />


                <div class="container">
                    <div class="form">

                        <div class="form-row">
                            <div class="form-group col-md-5">
                                <label for="txtDocumento">Nro. de documento</label>
                                <input type="text" v-model="documento" style="border:none;" disabled class="form-control" id="txtDocumento">
                            </div>
                            <div class="form-group col-md-7">
                                <label for="txtNombres">Nombres y Apellidos</label>
                                <input type="text" v-model="nombres" style="border:none;" disabled class="form-control" id="txtNombres">
                            </div>
                        </div>




                        <div class="form-group">
                            <label for="txtCorreo">Correo electronico*</label>
                            <input type="email" v-model="correo" style="border-color: #b5abb6" class="form-control" id="txtCorreo">
                            <span class="msgAlertaInt" v-if="msgAlertaCorreo != ''">{{msgAlertaCorreo}}</span>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="txtTelefono">Telefono</label>
                                <input type="text" v-model="telefono" style="border-color: #b5abb6" class="form-control" id="txtTelefono">
                                <span class="msgAlertaInt" v-if="msgAlertaTel != ''">{{msgAlertaTel}}</span>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="txtCelular">Celular</label>
                                <input type="text" v-model="celular" style="border-color: #b5abb6" class="form-control" id="txtCelular">
                                <span class="msgAlertaInt" v-if="msgAlertaCel != ''">{{msgAlertaCel}}</span>
                            </div>
                        </div>

                       

                        <div>
                            <span class="msgAlertaInt" v-if="msgAlerta != ''">{{msgAlerta}}</span>
                        </div>
                        <br />
                        <button class="btn btn-primary" type="button" v-on:click="paso2()" v-if="stateloader=='Comenzar'">Grabar</button>
                        <button class="btn btn-primary" type="button" disabled v-if="stateloader=='Cargando'">Validando...&nbsp;<b-spinner small></b-spinner></button>

                    </div>
                    <br />
                    <br />

                </div>
            </div>

            <div style="padding:15px;"></div>
            <div v-if="v_paso=='2'" class="col-lg-12" style="background-color: #FAFAFA;border-radius:25px;">
                <br />
                <br />
                <br />
                <p style="font-size:28px;font-weight:600;">Cambiar contraseña</p>

                <br />
                <br />


                <div class="container">
                    <div class="form">


                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="inputPassword4">Contraseña</label>
                                <input type="password" v-model="clave" style="border-color: #b5abb6" class="form-control" id="txtClave">
                                <span class="msgAlertaInt" v-if="msgAlertaClave != ''">{{msgAlertaClave}}</span>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="txtClaveRe">Valida Contraseña</label>
                                <input type="password" v-model="claveRe" style="border-color: #b5abb6" class="form-control" id="txtClaveRe">
                                <span class="msgAlertaInt" v-if="msgAlertaClaveRe != ''">{{msgAlertaClaveRe}}</span>
                            </div>
                        </div>

                        <div>
                            <span class="msgAlertaInt" v-if="msgAlerta2 != ''">{{msgAlerta2}}</span>
                        </div>
                        <br />
                        <button class="btn btn-primary" type="button" v-on:click="paso2_2()" v-if="stateloader2=='Comenzar'">Grabar</button>
                        <button class="btn btn-primary" type="button" disabled v-if="stateloader2=='Cargando'">Validando...&nbsp;<b-spinner small></b-spinner></button>

                    </div>
                    <br />
                    <br />

                </div>
            </div>

            <div v-if="v_paso=='3'" class="col-lg-12" style="background-color: #FAFAFA;border-radius:25px;">

                <div class="d-flex align-items-center justify-content-center">
                    <div class="div-msg-ok">
                        <p style="text-align:center;width:100%;font-size:14px;line-height:21px;margin-top:40px;margin-bottom:21px;">Sus datos fueron <br> actualizados correctamente</p>

                        <div class="div-flex-center">
                            <span style="font-size: 100px; width: 100%; text-align: center; color: #dc6606;" class="bi bi-check-circle"></span>
                        </div>
                        <br />
                        <div class="div-flex-center">
                            <button class="btn btn-primary" onclick="window.location.href='@Url.Content("~/PagosPF/MiCuenta")';">Regresar</button>
                        </div>

                    </div>
                </div>


            </div>

            <br />
            <br />
            <br />
            <br />
        </div>
    </div>

    <b-modal id="mdConfirmacion" centered size="md" title="Confirmación"
             ok-title="Aceptar"
             cancel-title="Cancelar"
             ok-variant="custom-ok"
             cancel-variant="custom-cancel"
             header-class="custom-modal-header"
             data-html="true" @@ok="handleAceptar" ok-first>

        <br />
        <p class="p-body-modal" style="line-height:25px;text-align:center;">Se actualizara los datos de tu cuenta.</p>
        <p class="p-body-modal" style="line-height:25px;text-align:center;">¿Desea continuar?</p>
    </b-modal>

    <b-modal id="mdConfirmacion2" centered size="md" title="Confirmación"
             ok-title="Aceptar"
             cancel-title="Cancelar"
             ok-variant="custom-ok"
             cancel-variant="custom-cancel"
             header-class="custom-modal-header"
             data-html="true" @@ok="handleAceptar2" ok-first>

        <br />
        <p class="p-body-modal" style="line-height:25px;text-align:center;">Se actualizara tu contraseña.</p>
        <p class="p-body-modal" style="line-height:25px;text-align:center;">¿Desea continuar?</p>
    </b-modal>

</div>


@section scripts {

    <script>

    var app = new Vue({
                el: '#app',
        data: {

                    v_paso: '1',
            msgAlerta: '',
            msgAlerta2: '',
                    msgAlertaCorreo: '',
                    msgAlertaTel: '',
                    msgAlertaCel: '',
                    msgAlertaClave: '',
                    msgAlertaClaveRe: '',
                    //model
            correo: '',
            telefono: '',
            celular: '',
            clave: '',
            documento: '',
            nombres: '',
            apellidos:'',
                    claveRe:'',
                    //loader
            stateloader: 'Comenzar',
            stateloader2: 'Comenzar',
                    disabledComenzar: true,
                    ID_USUARIO: '@User.Identity.Name',
                    USUARIO: '@Session["Usuario"].ToString()',
                    SERVER_URL: '@SERVIDOR'
        },
        methods: {

            validarCorreo(correo) {
                const regexCorreo = /^[a-zA-Z0-9._-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                return regexCorreo.test(correo);
            },
            pantalla: function (form) {
                this.$bvModal.show(form.PANTALLA);
            },


            paso1: function () {
                this.msgAlerta = '';
                axios.post('@SERVIDOR' + '/api/Usuarios/ActualizaUsuPagoPF', {
                         USUARIO: '@Session["Usuario"].ToString()',
                                PASSWORD: '',
                                TIPODOC: '',
                                TIPOVAL: 'consulta',
                                TEL_AFI: '',
                                CEL_AFI: '',
                                CORREO :  ''
                }).then(response => {
                    if (response.data.MSG == null) {
                        this.msgAlerta = 'Ocurrio un error....';
                    } else {
                        if (response.data.MSG == 'OK') {

                            /*ACTIVAR PASO 2 */
                            this.documento = response.data.USUARIO;
                            this.nombres = response.data.NOMBRES + ', ' + response.data.APELLIDO_PATERNO + ' ' + response.data.APELLIDO_MATERNO;
                            this.correo = response.data.CORREO;
                            this.telefono = response.data.TEL_AFI;
                            this.celular = response.data.CEL_AFI;
                            this.v_paso = '2';
                        } else {
                            this.msgAlerta = response.data.MSG;
                        }
                    }

                }).catch(e => {
                    this.msgAlerta = 'Error en la conexión...';
                }).finally(() => {
                    
                });
            },

            paso2: function (item) {
                this.telefono = this.telefono.trim();
                this.celular = this.celular.trim();
                this.correo = this.correo.trim().toLowerCase();
                this.msgAlerta = '';
                this.msgAlertaCorreo = '';
                this.msgAlertaTel = '';
                this.msgAlertaCel = '';
                var canErrores = 0;
                var tipoVal = '';

                if (this.correo == '') {
                    this.msgAlertaCorreo = 'Correo es obligatorio.';
                    canErrores++;

                } else {
                    //si es incorrecto false
                    if (!this.validarCorreo(this.correo)) {
                        this.msgAlertaCorreo = 'Ingrese correo con formato correcto.';
                        canErrores++;
                    }

                }

                if (this.telefono != '' ) {

                    if (this.telefono.length < 7) {
                        this.msgAlertaTel = 'Telefono debe tener minimo 7 digitos.';
                        canErrores++;
                    } else if (this.telefono.length > 15) {
                        this.msgAlertaTel = 'Telefono debe tener maximo 15 digitos.';
                        canErrores++;
                    }
                }

                if (this.celular != '') {

                    if (this.celular.length < 9) {
                        this.msgAlertaCel = 'Celular debe tener minimo 9 digitos.';
                        canErrores++;
                    } else if (this.celular.length > 15) {
                        this.msgAlertaCel = 'Celular debe tener maximo 15 digitos.';
                        canErrores++;
                    }
                }


                // Si hay errores, salimos
                if (canErrores > 0) {
                    return;
                } else {


                    this.pantalla({ PANTALLA: 'mdConfirmacion' });
                }

            },


            paso2_2:  function (item) {

                this.clave = this.clave.trim();
                this.claveRe = this.claveRe.trim();
                this.msgAlerta2 = '';
                this.msgAlertaClave = '';
                this.msgAlertaClaveRe = '';
                var canErrores = 0;
                var tipoVal = '';


                if (this.clave == '') {
                    this.msgAlertaClave = 'Ingrese contraseña.';
                    canErrores++;
                } else {

                    if (this.clave.length < 6) {
                        this.msgAlertaClave = 'Contraseña debe tener minimo 6 digitos.';
                        canErrores++;
                    } else if (this.clave.length > 12) {
                        this.msgAlertaClave = 'Contraseña debe tener maximo 12 digitos.';
                        canErrores++;
                    } else {
                        if (this.clave != this.claveRe) {
                            this.msgAlertaClave = 'Debe ser igual a confirmación de contraseña.';
                            canErrores++;
                        }
                    }

                }

                if (this.claveRe == '')
                {
                    this.msgAlertaClaveRe = 'Ingrese confirmacion de contraseña.';
                    canErrores++;
                } else {
                    if (this.clave != this.claveRe) {
                        this.msgAlertaClaveRe = 'Debe ser igual a contraseña.';
                        canErrores++;
                    }
                }

                // Si hay errores, salimos
                if (canErrores > 0) {
                    return;
                } else {


                    this.pantalla({ PANTALLA: 'mdConfirmacion2' });
                }

            },

            handleAceptar: async function (item) {

                try {
                    this.tipoVal = 'actualiza_data';
                      this.stateloader = 'Cargando';



                       const response = await axios.post('@SERVIDOR' + '/api/Usuarios/ActualizaUsuPagoPF', {
                                USUARIO: '@Session["Usuario"].ToString()',
                                PASSWORD: this.clave,
                                TIPODOC: '',
                                TIPOVAL: this.tipoVal,
                                TEL_AFI: this.telefono,
                                CEL_AFI: this.celular,
                                CORREO :  this.correo
                            });


                        // Comprobamos el mensaje de la respuesta
                        if (response.data.MSG == null) {
                            this.msgAlerta = 'Ocurrio un error....';
                        } else {
                            if (response.data.MSG == 'OK') {
                                this.v_paso = '3';
                            } else {
                                // Si la respuesta es otro mensaje, lo mostramos
                                this.msgAlerta = response.data.MSG;
                            }
                        }

                } catch (e) {
                        // En caso de error en la conexión
                        this.msgAlerta = 'Error en la conexión...';
                } finally {
                        // Esto se ejecuta independientemente de si hay error o no
                        this.stateloader = 'Comenzar';
                }


            },

            handleAceptar2: async function (item) {

                try {
                       this.tipoVal = 'actualiza_data_clave';
                      this.stateloader2 = 'Cargando';



                       const response = await axios.post('@SERVIDOR' + '/api/Usuarios/ActualizaUsuPagoPF', {
                                USUARIO: '@Session["Usuario"].ToString()',
                                PASSWORD: this.clave,
                                TIPODOC: '',
                                TIPOVAL: this.tipoVal,
                                TEL_AFI: this.telefono,
                                CEL_AFI: this.celular,
                                CORREO :  this.correo
                            });


                        // Comprobamos el mensaje de la respuesta
                        if (response.data.MSG == null) {
                            this.msgAlerta2 = 'Ocurrio un error....';
                        } else {
                            if (response.data.MSG == 'OK') {
                                this.v_paso = '3';
                            } else {
                                // Si la respuesta es otro mensaje, lo mostramos
                                this.msgAlerta2 = response.data.MSG;
                            }
                        }

                } catch (e) {
                        // En caso de error en la conexión
                        this.msgAlerta2 = 'Error en la conexión...';
                } finally {
                        // Esto se ejecuta independientemente de si hay error o no
                        this.stateloader2 = 'Comenzar';
                }


            },

        }

})

app.paso1();
    </script>

 }